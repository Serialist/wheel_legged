# DEVLOG

## 2026-01-01

前两天尝试了仿真，发现仿真也跑不起来，开始在其他开源寻找方法。

## 2026-01-07 0223 BJT

成功跑起来，发现原因却是在于 LQR 参数没调好

总结问题如下：

1. 为什么腿会疯：对 pitch 的权重太大，大胆减小就行。顺便大胆加大 theta 权重
2. 轮毂电机高频抖动：大概同样是 pitch 权重问题，可能和超调同理。在减小 pitch 的 Q 矩阵权重，同时增大 R 矩阵对轮毂力矩的代价权重，可以减少抖动。
3. 腿推力前馈是 $G \cdot cos(theta)$，不是触发。前馈作用是控制腿，不是让机体一直有支持力。

调试经验：

- 调试轮腿过程？

  1. VMC 解算，在无力状态下，用调试变量观察解算和逆解算结果是否正常。
  2. 使用 PID 控制髋关节和轮毂的力矩，尝试五连杆结构稳定（两个 PID 分别控制腿长和腿角度，腿角度不是 theta，是 alpha 即腿和机体相对角度）。
  3. 在 2 的基础上，调试板凳模型（即一阶倒立摆，只控制轮毂，髋关节 PID 定死，当平衡车调）。板凳模型的 LQR 可以先调真的一阶倒立摆模型的，也可以调二级倒立摆模型，但只把 x、v、pitch、dpitch 的计算结果加和输出到轮毂，调好后这 4 项的极性正确。
  4. 把车架起来，把轮毂无力，用 theta、dtheta 控制髋关节电机，完成后把车抱起来，腿应该一直垂直地面，此时 theta 极性正确。
  5. 保持车架起、轮无力，用完整 LQR 调试，此时可以看出髋关节时 LQR 的 Q 矩阵权重是否合理，应该腿和机体角度和 theta 角略有改变，相比 PID 更柔软，但腿不会直接倒下。
  6. 全开，保证安全，应该可以动了。

- 怎么调参数？

  可以先看看状态变量各自可以接受的最大变化程度，比如 x 可以接受 -0.5 到 0.5，但 pitch 只能接受在 - 0.3 到正 0.3，则两个的比例大概就是这两个量的比例。

  调 theta 的参数时，可以先看看板凳模型时 PID 的 k_p 和 k_d，大概使得 LQR 得到的 K 矩阵中，关节对应的 theta 和 dtheta 的系数和他相同。

  轮毂高频抖动可以加 R 矩阵对应轮毂力矩的权重。

- 跳跃？

  下蹲：收腿，腿长减小

  起跳：放腿长，或者直接加 VMC 的推力（腿长用 PID 控其实也是在加推力）

  收腿：空中收腿，尽量在达到推高点前收完，按照离地检测就行，加快收腿速度可以 VMC 推力给个负方向力。

  落地：收腿后再伸长一点用于缓冲，落地可以用离地检测接手，或者单纯等一小段时间。我用的延时，离地检测还不太完善。

- 腿长变化太快会摔一下？离地或腿变化时反复触发离地检测踹地板？

  1. 腿长 PID 调弹性大一点
  2. 前馈变化时加 ramp 函数，不要突然变化
